<!DOCTYPE html>
<html>
<head>
    <title>의류 분석 시스템</title>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.0/dist/js.cookie.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <style>
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            margin: 20px 0;
        }
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { background-color: #dc3545; }
            50% { background-color: #b02a37; }
            100% { background-color: #dc3545; }
        }
    </style>
    <script>
        let mediaRecorder;
        let audioStream;
        let audioChunks = [];
        let isRecording = false;

        $(document).ready(function() {
            // 파일 선택 시 미리보기
            $('#imageFile').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#imagePreview').attr('src', e.target.result);
                        $('#imagePreview').show();
                    }
                    reader.readAsDataURL(file);
                }
            });

            // 녹음 버튼 클릭
            $('#recordButton').click(async function() {
                if (!isRecording) {
                    if (!$('#imageFile').val()) {
                        alert('먼저 이미지를 선택해주세요.');
                        return;
                    }
                    
                    try {
                        audioStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: {
                                channelCount: 1,
                                sampleRate: 44100,
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true
                            }
                        });
                        
                        mediaRecorder = new MediaRecorder(audioStream, {
                            mimeType: 'audio/webm;codecs=opus',
                            audioBitsPerSecond: 128000
                        });
                        
                        audioChunks = [];

                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                                console.log('Recorded chunk:', event.data.size, 'bytes');
                            }
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                            console.log('Final recording size:', audioBlob.size, 'bytes');
                            
                            if (audioBlob.size > 0) {
                                const audioUrl = URL.createObjectURL(audioBlob);
                                $('#audioPreview').attr('src', audioUrl);
                                $('#audioPreview').show();
                                processAudioWithImage(audioBlob);
                            } else {
                                alert('녹음된 음성이 없습니다.');
                            }
                            
                            // 스트림 정리
                            audioStream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorder.start(100); // 100ms마다 데이터 수집
                        isRecording = true;
                        $(this).text('녹음 중지');
                        $(this).addClass('recording');
                        console.log('Recording started');

                    } catch (err) {
                        console.error('마이크 접근 오류:', err);
                        alert('마이크 접근에 실패했습니다.');
                    }
                } else {
                    mediaRecorder.stop();
                    isRecording = false;
                    $(this).text('음성 질문하기');
                    $(this).removeClass('recording');
                    console.log('Recording stopped');
                }
            });

            // 이미지 분석 버튼 클릭
            $('#analyzeButton').click(function() {
                if (!$('#imageFile').val()) {
                    alert('이미지를 선택해주세요.');
                    return;
                }
                submitImageAnalysis();
            });

            function submitImageAnalysis() {
                const formData = new FormData();
                formData.append('image', $('#imageFile')[0].files[0]);
                
                if ($('#questionText').val()) {
                    formData.append('question', $('#questionText').val());
                }

                $.ajax({
                    url: '/polls/analyze_image',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        addResponse('시스템', data.response);
                        playTTS(data.response);
                    },
                    error: function(error) {
                        console.error('분석 오류:', error);
                        alert('이미지 분석 중 오류가 발생했습니다.');
                    }
                });
            }

            function processAudioWithImage(audioBlob) {
                console.log('Processing audio size:', audioBlob.size, 'bytes');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'temp_audio.webm');
                formData.append('image', $('#imageFile')[0].files[0]);

                $.ajax({
                    url: '/polls/process_audio',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        if (data.question) {
                            addResponse('질문', data.question);
                            addResponse('시스템', data.response);
                            playTTS(data.response);
                        } else {
                            alert('음성 인식에 실패했습니다. 다시 시도해 주세요.');
                        }
                    },
                    error: function(error) {
                        console.error('처리 오류:', error);
                        alert('음성 처리 중 오류가 발생했습니다.');
                    }
                });
            }

            function addResponse(type, text) {
                const time = new Date().toLocaleTimeString();
                const icon = type === '질문' ? 'person' : 'robot';
                $('#responseArea').append(
                    `<p>(${time}) <i class="bi bi-${icon}"></i> ${type}: ${text}</p>`
                );
                $('#responseArea').scrollTop($('#responseArea')[0].scrollHeight);
            }

            function playTTS(text) {
                const audio = new Audio('/static/polls/sounds/speech.mp3');
                audio.play().catch(function(error) {
                    console.log("오디오 재생 실패:", error);
                });
            }
        });
    </script>
</head>
<body>
    <div class="container p-4">
        <h2 class="mb-4">의류 분석 시스템</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="imageFile" class="form-label">의류 이미지 업로드:</label>
                    <input type="file" class="form-control" id="imageFile" accept="image/*">
                </div>
                <img id="imagePreview" class="preview-image" style="display: none;">
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">질문 입력:</label>
                    <textarea id="questionText" class="form-control mb-2" rows="3" placeholder="텍스트로 질문하기..."></textarea>
                    <button id="analyzeButton" class="btn btn-primary me-2">분석하기</button>
                    <button id="recordButton" class="btn btn-danger">음성 질문하기</button>
                </div>
                <div class="mt-3">
                    <label>녹음된 음성:</label>
                    <audio id="audioPreview" controls style="display: none;"></audio>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h5>분석 결과:</h5>
            <div id="responseArea" class="border p-3 rounded bg-light" style="height: 300px; overflow-y: auto;">
            </div>
        </div>
    </div>
</body>
</html>